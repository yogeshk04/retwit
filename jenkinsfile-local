pipeline {
    agent any
    environment {
        GIT_COMMAND = '"C:\\Program Files\\Git\\bin\\bash.exe"'
        KUBECTL_COMMAND = 'kubectl'
        KUBECONFIG_PATH = 'C:\\Users\\Meenakshi Ulhas\\.kube\\config'
        MANIFESTS_PATH = 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\local-deployment\\manifest'
        BE_DOCKER_FILE = 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\local-deployment\\backend'
        FE_DOCKER_FILE = 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\local-deployment\\frontend'

        DOCKER_REGISTRY_URL = 'https://index.docker.io/v1/'
        DOCKER_REGISTRY_CREDENTIALS_ID = 'DOCKER_REGISTRY_CREDENTIALS_ID'
        DOCKERHUB_REPO_URL = 'yogeshk04/'
    }
    stages {
        stage('Stage 1: Clone Repository') {
            steps {
                script {
                    git 'https://github.com/yogeshk04/retwit.git'
                }
            }
        }

        stage('Stage 2: Build backend docker image') {
            steps {
                script {
                    dir("${env.BE_DOCKER_FILE}") {
                        bat "docker build -t ulhasmahajan/backend:v3 ."
                    }
                }
            }
        }

        stage('Stage 3: Build frontend docker image') {
            steps {
                script {
                    dir("${env.FE_DOCKER_FILE}") {
                        bat "docker build -t ulhasmahajan/frontend:v3 ."
                    }
                }
            }
        }

        stage('Stage 4: Docker login') {
            steps {
                script {
                    withDockerRegistry(credentialsId: env.DOCKER_REGISTRY_CREDENTIALS_ID, url: env.DOCKER_REGISTRY_URL) {
                        // Docker login is handled automatically
                    }
                }
            }
        }

        stage('Scan') {
            steps {
                // Install trivy
                sh 'curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.18.3'
                sh 'curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl > html.tpl'

                // Scan all vuln levels
                sh 'mkdir -p reports'
                sh 'trivy filesystem --ignore-unfixed --vuln-type os,library --format template --template "@html.tpl" -o reports/nodjs-scan.html ./nodejs'
                publishHTML target : [
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'reports',
                    reportFiles: 'nodjs-scan.html',
                    reportName: 'Trivy Scan',
                    reportTitles: 'Trivy Scan'
                ]

                // Scan again and fail on CRITICAL vulns
                sh 'trivy filesystem --ignore-unfixed --vuln-type os,library --exit-code 1 --severity CRITICAL ./nodejs'

            }
        }

        stage('Stage 5: Docker push images to DockerHub') {
            steps {
                script {
                    bat "docker push ulhasmahajan/backend:v3"
                    bat "docker push ulhasmahajan/frontend:v3"
                }
            }
        }

        stage('Stage 6: Deploy to Kubernetes cluster') {
            steps {
                script {
                    // Set KUBECONFIG for kubectl
                    withEnv(["KUBECONFIG=${env.KUBECONFIG_PATH}"]) {
                       dir("${env.MANIFESTS_PATH}") {
                            bat "${env.KUBECTL_COMMAND} apply -f ."
                        }
                    }
                }
            }
        }

        // Add more stages as needed for your build process
    }

    post {
        success {
            echo 'Build successful!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
